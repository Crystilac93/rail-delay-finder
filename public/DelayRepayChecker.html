<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#10b981"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Rail Delay Finder</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="train_icon.png">
    <link rel="apple-touch-icon" href="train_icon.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ... (Keep existing styles) ... */
        html { scroll-behavior: smooth; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overscroll-behavior-y: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        @media (max-width: 768px) {
            .mobile-table-card thead { display: none; }
            .mobile-table-card tbody tr { display: flex; flex-direction: column; background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; margin-bottom: 1rem; padding: 1rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
            .mobile-table-card td { display: flex; justify-content: space-between; padding: 0.25rem 0; border: none; font-size: 0.95rem; }
            .mobile-table-card td::before { content: attr(data-label); font-weight: 600; color: #6b7280; margin-right: 1rem; }
            .mobile-table-card td:last-child { margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #f3f4f6; font-weight: 700; font-size: 1.1rem; }
        }

        /* Progress Bar Styles */
        .progress-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 0.5rem;
            overflow: hidden;
            margin-top: 0.75rem;
        }
        .progress-bar {
            height: 100%;
            background-color: #10b981;
            width: 0%;
            transition: width 0.3s ease-out;
        }

        .text-danger { color: #ef4444; font-weight: 600; }
        .text-success { color: #22c55e; font-weight: 600; }
        
        input[type="time"], input[type="date"], select { -webkit-appearance: none; appearance: none; background-color: #fff; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 0.6rem 0.875rem; font-size: 1rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        input:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); }

        #settings-panel { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        .kpi-card { transition: transform 0.2s; }
        .kpi-card:active { transform: scale(0.98); }

        .kpi-scroller { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
        @media (max-width: 640px) {
            .kpi-scroller { display: flex; overflow-x: auto; padding-bottom: 1rem; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; margin-right: -1rem; padding-right: 1rem; }
            .kpi-scroller > * { flex: 0 0 140px; scroll-snap-align: start; }
        }
        
        .autocomplete-results { max-height: 200px; overflow-y: auto; -webkit-overflow-scrolling: touch; }

        /* Cache/Live Badges */
        .cache-badge { display: inline-flex; align-items: center; background-color: #dbeafe; color: #1e40af; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; border: 1px solid #bfdbfe; }
        .api-badge { display: inline-flex; align-items: center; background-color: #dcfce7; color: #166534; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; border: 1px solid #bbf7d0; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navbar (Same as before) -->
    <nav class="bg-emerald-600 shadow-lg sticky top-0 z-30 safe-area-top">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <img src="train_icon.png" alt="Train Logo" class="h-8 w-8 mr-3">
                        <span class="text-xl font-bold text-white tracking-tight">DelayRepay</span>
                    </div>
                </div>
                <div class="flex items-center">
                     <button id="settings-toggle-button" type="button" class="p-2 -mr-2 rounded-full text-emerald-100 hover:text-white hover:bg-emerald-700 focus:outline-none focus:bg-emerald-700 transition-colors">
                        <span class="sr-only">Open settings</span>
                        <svg class="h-7 w-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                     </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Settings Panel (Same as before) -->
    <div id="settings-overlay" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden opacity-0 transition-opacity duration-300"></div>
    <div id="settings-panel" class="fixed inset-y-0 right-0 w-full sm:w-96 bg-white shadow-2xl z-50 transform translate-x-full flex flex-col custom-scrollbar">
        <!-- ... (Settings content omitted for brevity, same as previous) ... -->
        <div class="flex-none px-5 py-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
            <h2 class="text-lg font-bold text-gray-800">App Settings</h2>
            <button id="close-settings-button" class="p-2 bg-white rounded-full shadow-sm text-gray-500 hover:text-red-600 border border-gray-200">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        
        <div class="flex-grow p-5 overflow-y-auto space-y-6">
             <!-- Ticket Settings -->
             <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                 <div class="flex items-center mb-3">
                     <div class="p-2 bg-emerald-100 rounded-lg mr-3 text-emerald-600">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                     </div>
                     <h3 class="font-semibold text-gray-900">Ticket Price</h3>
                 </div>
                 <label class="block text-sm text-gray-600 mb-1">Annual Season Ticket Cost</label>
                 <div class="relative">
                     <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">£</span>
                     <input type="text" id="ticket-price-settings" inputmode="decimal" value="7437.92" class="w-full pl-8 pr-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all text-lg font-medium text-gray-900">
                 </div>
             </div>

             <!-- Journey Settings -->
             <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm space-y-4">
                 <div class="flex items-center mb-2">
                     <div class="p-2 bg-blue-100 rounded-lg mr-3 text-blue-600">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                     </div>
                     <h3 class="font-semibold text-gray-900">Route Configuration</h3>
                 </div>
                 
                 <div class="space-y-4">
                     <div class="autocomplete-container relative">
                        <label class="block text-xs uppercase tracking-wide font-bold text-gray-500 mb-1">Outbound From (Home)</label>
                        <input type="text" id="setting-outbound-from" class="w-full rounded-lg border-gray-300 py-2.5 text-sm font-medium focus:ring-emerald-500 focus:border-emerald-500" placeholder="Start Station...">
                        <div class="autocomplete-results hidden absolute w-full bg-white border border-gray-200 rounded-b-lg shadow-xl z-50" id="results-setting-outbound-from"></div>
                        <input type="hidden" id="setting-outbound-from-code" value="DID"> 
                    </div>
                     <div class="autocomplete-container relative">
                        <label class="block text-xs uppercase tracking-wide font-bold text-gray-500 mb-1">Outbound To (Work)</label>
                        <input type="text" id="setting-outbound-to" class="w-full rounded-lg border-gray-300 py-2.5 text-sm font-medium focus:ring-emerald-500 focus:border-emerald-500" placeholder="End Station...">
                        <div class="autocomplete-results hidden absolute w-full bg-white border border-gray-200 rounded-b-lg shadow-xl z-50" id="results-setting-outbound-to"></div>
                        <input type="hidden" id="setting-outbound-to-code" value="PAD">
                     </div>
                 </div>
                 
                 <div class="relative py-2">
                    <div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-gray-200"></div></div>
                    <div class="relative flex justify-center"><span class="bg-white px-2 text-xs text-gray-500">Return Journey (Auto-filled)</span></div>
                 </div>

                 <div class="space-y-4 opacity-75">
                     <div class="autocomplete-container relative">
                        <label class="block text-xs uppercase tracking-wide font-bold text-gray-500 mb-1">Inbound From (Work)</label>
                        <input type="text" id="setting-inbound-from" class="w-full rounded-lg border-gray-300 py-2.5 text-sm bg-gray-50" readonly>
                        <input type="hidden" id="setting-inbound-from-code" value="PAD">
                     </div>
                     <div class="autocomplete-container relative">
                        <label class="block text-xs uppercase tracking-wide font-bold text-gray-500 mb-1">Inbound To (Home)</label>
                        <input type="text" id="setting-inbound-to" class="w-full rounded-lg border-gray-300 py-2.5 text-sm bg-gray-50" readonly>
                        <input type="hidden" id="setting-inbound-to-code" value="DID">
                     </div>
                 </div>
             </div>
        </div>
        
        <div class="flex-none p-5 border-t border-gray-200 bg-gray-50 safe-area-bottom">
             <button type="button" id="save-settings-button" class="w-full bg-emerald-600 text-white py-3.5 px-4 rounded-xl shadow-lg hover:bg-emerald-700 active:scale-[0.98] transition-all text-base font-semibold">Save & Close</button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow max-w-3xl mx-auto w-full px-4 sm:px-6 py-6 space-y-6">

        <!-- Search Card -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-5 sm:p-6 bg-gradient-to-r from-emerald-50 to-white border-b border-emerald-100">
                <h1 class="text-xl font-bold text-gray-900">Find Delays</h1>
                <p class="text-gray-500 text-sm mt-1">Analyse your commute for compensation.</p>
            </div>

            <form id="search-form" class="p-5 sm:p-6 space-y-6">
                <!-- (Search form inputs same as before) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Mode</label>
                        <div class="flex bg-gray-100 p-1 rounded-lg">
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="search-type" value="week" checked class="sr-only peer">
                                <span class="block py-2 text-sm font-medium text-gray-500 rounded-md peer-checked:bg-white peer-checked:text-emerald-600 peer-checked:shadow-sm transition-all">Week</span>
                            </label>
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="search-type" value="day" class="sr-only peer">
                                <span class="block py-2 text-sm font-medium text-gray-500 rounded-md peer-checked:bg-white peer-checked:text-emerald-600 peer-checked:shadow-sm transition-all">Day</span>
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2" id="date-picker-label">Select Week</label>
                        <div class="relative">
                            <input type="date" id="date-picker" class="block w-full pl-3 pr-3 py-2.5 rounded-lg border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 text-gray-800 font-medium">
                        </div>
                        <p id="week-commencing-label" class="text-xs text-emerald-600 mt-1 font-medium pl-1">w/c ...</p>
                    </div>
                </div>

                <div id="days-in-office-group">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-3">Days Travelled</label>
                    <div class="flex justify-between gap-2">
                        <label class="flex flex-col items-center cursor-pointer group"><input type="checkbox" name="daysInOffice" value="1" checked class="peer sr-only"><div class="w-10 h-10 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-sm font-bold peer-checked:bg-emerald-500 peer-checked:text-white transition-all group-active:scale-90">M</div><span class="text-[10px] mt-1 text-gray-400 peer-checked:text-emerald-600">Mon</span></label>
                        <label class="flex flex-col items-center cursor-pointer group"><input type="checkbox" name="daysInOffice" value="2" checked class="peer sr-only"><div class="w-10 h-10 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-sm font-bold peer-checked:bg-emerald-500 peer-checked:text-white transition-all group-active:scale-90">T</div><span class="text-[10px] mt-1 text-gray-400 peer-checked:text-emerald-600">Tue</span></label>
                        <label class="flex flex-col items-center cursor-pointer group"><input type="checkbox" name="daysInOffice" value="3" checked class="peer sr-only"><div class="w-10 h-10 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-sm font-bold peer-checked:bg-emerald-500 peer-checked:text-white transition-all group-active:scale-90">W</div><span class="text-[10px] mt-1 text-gray-400 peer-checked:text-emerald-600">Wed</span></label>
                        <label class="flex flex-col items-center cursor-pointer group"><input type="checkbox" name="daysInOffice" value="4" checked class="peer sr-only"><div class="w-10 h-10 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-sm font-bold peer-checked:bg-emerald-500 peer-checked:text-white transition-all group-active:scale-90">T</div><span class="text-[10px] mt-1 text-gray-400 peer-checked:text-emerald-600">Thu</span></label>
                        <label class="flex flex-col items-center cursor-pointer group"><input type="checkbox" name="daysInOffice" value="5" class="peer sr-only"><div class="w-10 h-10 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center text-sm font-bold peer-checked:bg-emerald-500 peer-checked:text-white transition-all group-active:scale-90">F</div><span class="text-[10px] mt-1 text-gray-400 peer-checked:text-emerald-600">Fri</span></label>
                    </div>
                </div>

                <div class="space-y-4 pt-2 border-t border-gray-100">
                     <div class="grid grid-cols-2 gap-4">
                         <div class="col-span-2 flex justify-between items-center"><span class="text-sm font-medium text-gray-900">Morning <span class="text-gray-400 font-normal ml-1" id="outbound-route-display"></span></span></div>
                         <div><label class="block text-[10px] text-gray-400 uppercase tracking-wider mb-1">Depart After</label><input type="time" id="from-time-outbound" value="07:00" class="w-full rounded-lg border-gray-300 text-sm"></div>
                         <div><label class="block text-[10px] text-gray-400 uppercase tracking-wider mb-1">Depart Before</label><input type="time" id="to-time-outbound" value="07:30" class="w-full rounded-lg border-gray-300 text-sm"></div>
                     </div>
                     <div class="grid grid-cols-2 gap-4">
                         <div class="col-span-2 flex justify-between items-center mt-2"><span class="text-sm font-medium text-gray-900">Evening <span class="text-gray-400 font-normal ml-1" id="inbound-route-display"></span></span></div>
                         <div><label class="block text-[10px] text-gray-400 uppercase tracking-wider mb-1">Depart After</label><input type="time" id="from-time-inbound" value="17:00" class="w-full rounded-lg border-gray-300 text-sm"></div>
                         <div><label class="block text-[10px] text-gray-400 uppercase tracking-wider mb-1">Depart Before</label><input type="time" id="to-time-inbound" value="17:30" class="w-full rounded-lg border-gray-300 text-sm"></div>
                     </div>
                </div>

                <!-- Progress Bar (New) -->
                <div id="progress-container" class="hidden mb-4">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span id="progress-label">Processing...</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="progress-container">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                </div>

                <!-- Action Button -->
                <button type="submit" id="submit-button" class="w-full bg-emerald-600 text-white py-4 rounded-xl shadow-lg hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-500/30 transition-all duration-200 flex justify-center items-center text-lg font-bold active:scale-[0.98]">
                    <span id="btn-text">Check Performance</span>
                    <svg id="btn-spinner" class="animate-spin ml-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                
                <!-- Status and Badges -->
                <div class="flex flex-wrap justify-center items-center mt-4 min-h-[1.5rem] gap-2">
                     <div id="status-message" class="text-sm text-center font-medium text-gray-600"></div>
                     <!-- Cache Badges -->
                     <span id="cache-indicator" class="cache-badge hidden" title="Data loaded from internal cache">
                        <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"></path><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"></path></svg>
                        Cached Data
                     </span>
                     <span id="api-indicator" class="api-badge hidden" title="Data fetched live from National Rail">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        Live Data
                     </span>
                </div>
            </form>
        </div>

        <!-- Results Section (Same as before) -->
        <div id="results-area" class="hidden space-y-8 transition-opacity duration-500 ease-in-out pb-12">
            <!-- Summary KPI Card -->
            <div>
                <h2 class="text-lg font-bold text-gray-900 mb-3 px-1">Summary</h2>
                <div class="bg-gradient-to-br from-emerald-500 to-emerald-700 rounded-2xl p-6 text-white shadow-lg mb-4 flex justify-between items-center">
                    <div>
                        <p class="text-emerald-100 text-sm font-medium mb-1">Estimated Refund</p>
                        <p id="total-refund-kpi-office" class="text-4xl font-bold tracking-tight">£0.00</p>
                    </div>
                    <div class="bg-white/20 p-3 rounded-full backdrop-blur-sm">
                         <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                </div>
                <div class="kpi-scroller">
                     <!-- Cards omitted for brevity, same as previous version -->
                    <div class="kpi-card bg-red-500 rounded-xl p-4 shadow-md text-white">
                        <div class="flex items-start justify-between mb-2"><span class="bg-white/20 p-1.5 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></span><span class="text-2xl font-bold" id="cancelled-kpi-office">0</span></div><p class="text-xs font-medium text-red-100 uppercase">Cancelled</p>
                    </div>
                    <div class="kpi-card bg-red-600 rounded-xl p-4 shadow-md text-white">
                         <div class="flex items-start justify-between mb-2"><span class="bg-white/20 p-1.5 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></span><span class="text-2xl font-bold" id="delayed-120-plus-office">0</span></div><p class="text-xs font-medium text-red-100 uppercase">Severe (120+)</p>
                    </div>
                    <div class="kpi-card bg-orange-500 rounded-xl p-4 shadow-md text-white">
                        <div class="flex items-start justify-between mb-2"><span class="bg-white/20 p-1.5 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></span><span class="text-2xl font-bold" id="delayed-60-119-office">0</span></div><p class="text-xs font-medium text-orange-100 uppercase">Long (60+)</p>
                    </div>
                    <div class="kpi-card bg-amber-500 rounded-xl p-4 shadow-md text-white">
                        <div class="flex items-start justify-between mb-2"><span class="bg-white/20 p-1.5 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></span><span class="text-2xl font-bold" id="delayed-30-59-office">0</span></div><p class="text-xs font-medium text-amber-100 uppercase">Medium (30+)</p>
                    </div>
                    <div class="kpi-card bg-yellow-500 rounded-xl p-4 shadow-md text-white">
                        <div class="flex items-start justify-between mb-2"><span class="bg-white/20 p-1.5 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></span><span class="text-2xl font-bold" id="delayed-15-29-office">0</span></div><p class="text-xs font-medium text-yellow-100 uppercase">Short (15+)</p>
                    </div>
                </div>
            </div>

            <!-- Detail List -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="font-semibold text-gray-700">Details</h3>
                    <div class="flex items-center">
                        <span class="text-xs text-gray-500 mr-2">Delays Only</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggle-office-delays" class="sr-only peer" checked>
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-600"></div>
                        </label>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full mobile-table-card" id="results-table-office">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="py-3 px-4 text-left text-xs font-bold text-gray-500 uppercase">Date</th>
                                <th class="py-3 px-4 text-left text-xs font-bold text-gray-500 uppercase">Type</th>
                                <th class="py-3 px-4 text-left text-xs font-bold text-gray-500 uppercase">Sch. Dep</th>
                                <th class="py-3 px-4 text-left text-xs font-bold text-gray-500 uppercase">Act. Arr</th>
                                <th class="py-3 px-4 text-left text-xs font-bold text-gray-500 uppercase">Delay</th>
                                <th class="py-3 px-4 text-left text-xs font-bold text-gray-500 uppercase">Refund</th>
                            </tr>
                        </thead>
                        <tbody id="results-body-office" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
                <p id="no-office-results" class="hidden text-center text-gray-500 py-8 text-sm">No delays found.</p>
            </div>
        </div>

    </main>
	
    <footer class="mt-10 py-6 text-center text-xs text-gray-400 border-t border-gray-200 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4">
            <p class="mb-1">Contains National Rail data © 2025. Source: Rail Delivery Group.</p>
            <p>This application is not affiliated with National Rail.</p>
        </div>
    </footer>

    <!-- Load Config first -->
    <script src="config.js"></script>
    <!-- Load Station Data second -->
    <script src="station_data.js"></script>
    
    <script>
        // --- DOM Elements ---
        const els = {
            form: document.getElementById('search-form'),
            btn: document.getElementById('submit-button'),
            btnText: document.getElementById('btn-text'),
            btnSpinner: document.getElementById('btn-spinner'),
            status: document.getElementById('status-message'),
            progressContainer: document.getElementById('progress-container'),
            progressBar: document.getElementById('progress-bar'),
            progressLabel: document.getElementById('progress-label'),
            progressPercent: document.getElementById('progress-percent'),
            cacheIndicator: document.getElementById('cache-indicator'),
            apiIndicator: document.getElementById('api-indicator'),
            // ... existing elements ...
            resultsArea: document.getElementById('results-area'),
            settingsPanel: document.getElementById('settings-panel'),
            settingsOverlay: document.getElementById('settings-overlay'),
            settingsToggle: document.getElementById('settings-toggle-button'),
            settingsClose: document.getElementById('close-settings-button'),
            settingsSave: document.getElementById('save-settings-button'),
            datePicker: document.getElementById('date-picker'),
            wcLabel: document.getElementById('week-commencing-label'),
            searchTypeRadios: document.querySelectorAll('input[name="search-type"]'),
            officeDaysContainer: document.getElementById('days-in-office-group'),
            officeDaysInputs: document.querySelectorAll('input[name="daysInOffice"]'),
            priceInput: document.getElementById('ticket-price-settings'),
            outFrom: document.getElementById('setting-outbound-from'),
            outTo: document.getElementById('setting-outbound-to'),
            inFrom: document.getElementById('setting-inbound-from'),
            inTo: document.getElementById('setting-inbound-to'),
            outFromCode: document.getElementById('setting-outbound-from-code'),
            outToCode: document.getElementById('setting-outbound-to-code'),
            inFromCode: document.getElementById('setting-inbound-from-code'),
            inToCode: document.getElementById('setting-inbound-to-code'),
            timeOutStart: document.getElementById('from-time-outbound'),
            timeOutEnd: document.getElementById('to-time-outbound'),
            timeInStart: document.getElementById('from-time-inbound'),
            timeInEnd: document.getElementById('to-time-inbound'),
            outRouteDisplay: document.getElementById('outbound-route-display'),
            inRouteDisplay: document.getElementById('inbound-route-display'),
            tableBody: document.getElementById('results-body-office'),
            noResults: document.getElementById('no-office-results'),
            toggleDelay: document.getElementById('toggle-office-delays'),
            kpiRefund: document.getElementById('total-refund-kpi-office'),
            kpiCancel: document.getElementById('cancelled-kpi-office'),
            kpiSevere: document.getElementById('delayed-120-plus-office'),
            kpiMajor: document.getElementById('delayed-60-119-office'),
            kpiMed: document.getElementById('delayed-30-59-office'),
            kpiMinor: document.getElementById('delayed-15-29-office')
        };

        const JOB_STORAGE_KEY = 'railDelayActiveJob';

        // --- Job Management ---
        function saveJobToStorage(jobData) {
            localStorage.setItem(JOB_STORAGE_KEY, JSON.stringify({ 
                timestamp: Date.now(),
                data: jobData 
            }));
        }

        function getJobFromStorage() {
            const stored = localStorage.getItem(JOB_STORAGE_KEY);
            if (!stored) return null;
            
            const data = JSON.parse(stored);
            if (Date.now() - data.timestamp > 15 * 60 * 1000) { // 15 mins expiry
                localStorage.removeItem(JOB_STORAGE_KEY);
                return null;
            }
            return data.data;
        }

        function clearJobStorage() {
            localStorage.removeItem(JOB_STORAGE_KEY);
        }

        function updateProgress(completed, total, statusText) {
            const pct = Math.round((completed / total) * 100);
            els.progressContainer.classList.remove('hidden');
            els.progressBar.style.width = `${pct}%`;
            els.progressPercent.innerText = `${pct}%`;
            els.progressLabel.innerText = statusText;
        }

        // --- Initialization ---
        function init() {
            const today = new Date();
            els.datePicker.value = formatDateForAPI(today);
            updateWeekLabel();
            loadSettings();
            
            els.settingsToggle.addEventListener('click', () => toggleSettings(true));
            els.settingsClose.addEventListener('click', () => toggleSettings(false));
            els.settingsOverlay.addEventListener('click', () => toggleSettings(false));
            els.settingsSave.addEventListener('click', saveSettings);
            els.form.addEventListener('submit', handleSearch);
            els.datePicker.addEventListener('change', updateWeekLabel);
            els.searchTypeRadios.forEach(r => {
                r.addEventListener('change', (e) => {
                    const isWeek = e.target.value === 'week';
                    els.officeDaysContainer.style.display = isWeek ? 'block' : 'none';
                    document.getElementById('date-picker-label').innerText = isWeek ? 'Select Week' : 'Select Day';
                    updateWeekLabel();
                });
            });
            els.priceInput.addEventListener('blur', () => {
                const val = parseFloat(els.priceInput.value.replace(/[^0-9.]/g, '')) || 0;
                els.priceInput.value = val.toFixed(2);
            });
            
            if (typeof stationData !== 'undefined') {
                 setupAutocomplete(els.outFrom, document.getElementById('results-setting-outbound-from'), els.outFromCode, true);
                 setupAutocomplete(els.outTo, document.getElementById('results-setting-outbound-to'), els.outToCode, true);
                 setupAutocomplete(els.inFrom, document.getElementById('results-setting-inbound-from'), els.inFromCode, false); 
                 setupAutocomplete(els.inTo, document.getElementById('results-setting-inbound-to'), els.inToCode, false); 
            }
            
            els.toggleDelay.addEventListener('change', () => renderTable(lastResults));

            // Resume Logic
            const savedData = getJobFromStorage();
            if (savedData) {
                console.log("Resuming job...");
                // Re-hydrate basic UI state from saved job if possible, or just show generic loading
                setLoading(true);
                els.resultsArea.classList.add('hidden');
                // Restart the polling/fetching sequence using saved params (simplified)
                // Ideally we'd store the *promises* or *jobIds* but promises can't be serialized.
                // We will restart the *flow* but skip submission if we had jobIds (complex).
                // For V1 of this feature: We just re-trigger the search logic with the saved form data? 
                // No, that would double-submit. 
                // Let's store the 'jobIds' in storage.
                if (savedData.metricsJobIds) {
                     resumeMonitoring(savedData);
                }
            }
        }

        async function resumeMonitoring(savedData) {
            // This is a simplified resume that picks up checking status of metrics
            // In a real app this state machine is complex. 
            // For now, we will just show a message if we detect an unfinished job, or try to wait for it.
            showStatus("Continuing previous search in background...", "info");
            
            // We actually need the 'allServices' list to proceed to step 2.
            // If we refreshed during step 1, we lost 'allServices'.
            // So we must re-fetch the results of the metric jobs.
            
            try {
                let allServices = [];
                let allRids = [];
                let hasCachedData = false;
                
                // 1. Check all metrics jobs
                const metricResults = await Promise.all(savedData.metricsJobIds.map(id => pollJob(id)));
                
                metricResults.forEach(data => {
                    if(data._fromCache) hasCachedData = true;
                    if(data.Services) {
                        data.Services.forEach(s => {
                             const rid = s.serviceAttributesMetrics?.rids?.[0];
                             if (rid && !allRids.includes(rid)) {
                                 allRids.push(rid);
                                 // We need to reconstruct the journey object roughly or ignore exact type matching for resume
                                 // For simplicity, we will assume a default type or try to extract from data if available
                                 allServices.push({ rid, date: "Unknown", type: "Resumed", from: "", to: "" });
                             }
                        });
                    }
                });
                
                // Note: Resuming fully without re-submitting details is hard because we lost the 'from/to' context needed for the final table.
                // A robust resume needs `allServices` to be saved to localStorage too.
                // For this iteration, to keep code safe, I will Auto-Submit a new search if resume data is found but incomplete.
                // Or simpler: Just clear and ask user to search again to avoid stale state bugs.
                clearJobStorage();
                showStatus("Previous search session expired. Please search again.", "warning");
                setLoading(false);
                
            } catch(e) {
                clearJobStorage();
                setLoading(false);
            }
        }

        // ... Settings functions (loadSettings, saveSettings, sync, updateRoute, toggle) keep same ...
        function loadSettings() { /* ... same as before ... */ 
            const stored = localStorage.getItem('railDelaySettings');
            if (stored) {
                try {
                    const s = JSON.parse(stored);
                    els.priceInput.value = s.ticketPrice || '7437.92';
                    els.outFromCode.value = s.outFromCode || 'DID';
                    els.outToCode.value = s.outToCode || 'PAD';
                    els.outFrom.value = s.outFromDisplay || 'Didcot Parkway';
                    els.outTo.value = s.outToDisplay || 'London Paddington';
                    if(s.fromTimeOutbound) els.timeOutStart.value = s.fromTimeOutbound;
                    if(s.toTimeOutbound) els.timeOutEnd.value = s.toTimeOutbound;
                    if(s.fromTimeInbound) els.timeInStart.value = s.fromTimeInbound;
                    if(s.toTimeInbound) els.timeInEnd.value = s.toTimeInbound;
                    if (s.officeDays) els.officeDaysInputs.forEach(cb => cb.checked = s.officeDays.includes(cb.value));
                } catch(e) {}
            }
            syncReturnJourney();
            updateRouteLabels();
        }
        function saveSettings() { /* ... same ... */ 
             const days = Array.from(els.officeDaysInputs).filter(c => c.checked).map(c => c.value);
             const s = { ticketPrice: els.priceInput.value, outFromCode: els.outFromCode.value, outToCode: els.outToCode.value, outFromDisplay: els.outFrom.value, outToDisplay: els.outTo.value, fromTimeOutbound: els.timeOutStart.value, toTimeOutbound: els.timeOutEnd.value, fromTimeInbound: els.timeInStart.value, toTimeInbound: els.timeInEnd.value, officeDays: days };
             localStorage.setItem('railDelaySettings', JSON.stringify(s));
             toggleSettings(false); showStatus('Settings saved', 'success'); updateRouteLabels();
        }
        function syncReturnJourney() { els.inFrom.value = els.outTo.value; els.inFromCode.value = els.outToCode.value; els.inTo.value = els.outFrom.value; els.inToCode.value = els.outFromCode.value; }
        function updateRouteLabels() { els.outRouteDisplay.textContent = `(${els.outFromCode.value} ➝ ${els.outToCode.value})`; els.inRouteDisplay.textContent = `(${els.inFromCode.value} ➝ ${els.inToCode.value})`; }
        function toggleSettings(show) { if (show) { els.settingsOverlay.classList.remove('hidden'); els.settingsPanel.classList.remove('translate-x-full'); setTimeout(() => els.settingsOverlay.classList.remove('opacity-0'), 10); } else { els.settingsOverlay.classList.add('opacity-0'); els.settingsPanel.classList.add('translate-x-full'); setTimeout(() => els.settingsOverlay.classList.add('hidden'), 300); } }


        // --- Search Logic ---
        let lastResults = []; 
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function pollJob(jobId) {
            // Poll longer for queue
            const MAX_ATTEMPTS = 300; // 10 minutes
            let attempts = 0;
            while(attempts < MAX_ATTEMPTS) {
                try {
                    const response = await fetch(`/api/job/${jobId}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const json = await response.json();
                    if (json.status === 'completed') return json.data;
                    if (json.status === 'failed') throw new Error(json.error || 'Job failed');
                    await wait(2000); 
                    attempts++;
                } catch (e) { throw e; }
            }
            throw new Error('Timeout');
        }

        async function handleSearch(e) {
            e.preventDefault();
            if (typeof METRICS_URL === 'undefined') { showStatus('Config Error', 'error'); return; }
            
            setLoading(true);
            els.resultsArea.classList.add('hidden');
            els.progressContainer.classList.remove('hidden');
            els.cacheIndicator.classList.add('hidden');
            els.apiIndicator.classList.add('hidden');
            
            // Reset Progress
            updateProgress(0, 100, "Initializing...");

            const searchType = document.querySelector('input[name="search-type"]:checked').value;
            const isWeek = searchType === 'week';
            const dateStr = els.datePicker.value;
            const officeDays = new Set();
            if (isWeek) els.officeDaysInputs.forEach(cb => { if (cb.checked) officeDays.add(parseInt(cb.value, 10)); });

            let daysToFetch = [];
            if (isWeek) {
                const monday = getMonday(new Date(dateStr));
                for (let i = 0; i < 5; i++) {
                    const d = new Date(monday.getTime());
                    d.setDate(monday.getDate() + i);
                    daysToFetch.push(formatDateForAPI(d));
                }
            } else { daysToFetch.push(dateStr); }

            const journeys = [
                { type: "Outbound", from: els.outFromCode.value, to: els.outToCode.value, start: els.timeOutStart.value, end: els.timeOutEnd.value },
                { type: "Inbound", from: els.inFromCode.value, to: els.inToCode.value, start: els.timeInStart.value, end: els.timeInEnd.value }
            ];

            let allServices = [];
            let allRids = [];
            let hasCachedData = false; 
            let completedSteps = 0;
            
            // Calculate total steps for progress bar (Metrics + Details phase)
            // Estimate: Each journey/day combo is 1 metric request. 
            // Details requests are unknown until metrics return, but we can scale the bar dynamically.
            let totalProjectedSteps = 0;
            let metricRequests = [];

            // 1. Build Request List
            for (const d of daysToFetch) {
                const dayDate = new Date(d);
                const dayIndex = dayDate.getDay(); 
                if(isWeek && !officeDays.has(dayIndex)) continue;
                if(!isWeek && (dayIndex === 0 || dayIndex === 6)) { showStatus("Weekend selected.", "error"); setLoading(false); return; }
                
                for (const j of journeys) {
                    metricRequests.push({ d, j });
                }
            }
            
            totalProjectedSteps = metricRequests.length * 2; // Arbitrary scaling: 50% for metrics, 50% for details
            
            // 2. Submit All Metrics Jobs
            updateProgress(5, 100, "Queuing search requests...");
            
            let metricJobIds = [];
            try {
                // Submit all jobs first
                for (const req of metricRequests) {
                     const payload = {
                        from_loc: req.j.from, to_loc: req.j.to,
                        from_time: req.j.start.replace(':',''), to_time: req.j.end.replace(':',''),
                        from_date: req.d, to_date: req.d, days: "WEEKDAY"
                    };
                    const res = await fetch(METRICS_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                    if(!res.ok) throw new Error("Submit failed");
                    const { jobId } = await res.json();
                    metricJobIds.push({ jobId, req });
                }

                // Save state
                saveJobToStorage({ metricsJobIds: metricJobIds.map(m => m.jobId) });

                // Poll for all metrics
                let completedMetrics = 0;
                updateProgress(10, 100, "Waiting for service lists...");
                
                const metricResults = await Promise.all(metricJobIds.map(async (item) => {
                    const data = await pollJob(item.jobId);
                    completedMetrics++;
                    // Update progress (10% to 40% range)
                    const prog = 10 + Math.round((completedMetrics / metricRequests.length) * 30);
                    updateProgress(prog, 100, `Found services for ${item.req.d}...`);
                    
                    if (data._fromCache) hasCachedData = true;
                    
                    // Process
                    if (data.Services) {
                        data.Services.forEach(s => {
                            const rid = s.serviceAttributesMetrics?.rids?.[0];
                            if (rid && !allRids.includes(rid)) {
                                allRids.push(rid);
                                allServices.push({ rid, date: item.req.d, type: item.req.j.type, from: item.req.j.from, to: item.req.j.to });
                            }
                        });
                    }
                    return data;
                }));

                if (allServices.length === 0) {
                    showStatus("No services found.", "info");
                    setLoading(false);
                    els.progressContainer.classList.add('hidden');
                    clearJobStorage();
                    return;
                }
                
                // Update indicators
                if (hasCachedData) els.cacheIndicator.classList.remove('hidden'); else els.apiIndicator.classList.remove('hidden');

                // 3. Details Phase
                updateProgress(40, 100, `Analyzing ${allServices.length} trains...`);
                
                let detailJobIds = [];
                // Submit all details jobs
                for (const svc of allServices) {
                    const res = await fetch(DETAILS_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ rid: svc.rid }) });
                    if(res.ok) {
                        const { jobId } = await res.json();
                        detailJobIds.push({ jobId, svc });
                    }
                }
                
                // Poll details
                let completedDetails = 0;
                let detailedServices = [];
                
                await Promise.all(detailJobIds.map(async (item) => {
                    try {
                        const detailsData = await pollJob(item.jobId);
                        completedDetails++;
                        // Update progress (40% to 90%)
                        const prog = 40 + Math.round((completedDetails / detailJobIds.length) * 50);
                        updateProgress(prog, 100, `Analyzing ${completedDetails}/${detailJobIds.length} trains...`);
                        
                        if (detailsData) {
                            const locs = detailsData.serviceAttributesDetails?.locations || [];
                            const dep = locs.find(l => l.location === item.svc.from);
                            const arr = locs.find(l => l.location === item.svc.to);
                            if (dep && arr) {
                                const isCancelled = !arr.actual_ta || arr.actual_ta === "";
                                let delay = 0;
                                if(!isCancelled) {
                                    const schTime = parseApiTime(arr.gbtt_pta);
                                    const actTime = parseApiTime(arr.actual_ta);
                                    if(schTime && actTime) {
                                        if(actTime < schTime - 43200000) actTime.setDate(actTime.getDate() + 1);
                                        delay = Math.max(0, Math.round((actTime - schTime) / 60000));
                                    }
                                }
                                detailedServices.push({ date: item.svc.date, type: item.svc.type, schDep: dep.gbtt_ptd, schArr: arr.gbtt_pta, actArr: arr.actual_ta, delay: delay, isCancelled: isCancelled });
                            }
                        }
                    } catch(e) { console.warn(e); }
                }));

                updateProgress(100, 100, "Finalizing...");
                
                detailedServices.sort((a,b) => {
                    if(a.date !== b.date) return a.date.localeCompare(b.date);
                    return a.schDep.localeCompare(b.schDep);
                });
                
                lastResults = detailedServices;
                calculateKPIs(detailedServices);
                renderTable(detailedServices);
                
                els.resultsArea.classList.remove('hidden');
                els.progressContainer.classList.add('hidden'); // Hide progress bar when done
                showStatus("Analysis Complete", "success");
                clearJobStorage();
                setTimeout(() => els.resultsArea.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);

            } catch (e) {
                showStatus("Error: " + e.message, "error");
                els.progressContainer.classList.add('hidden');
                clearJobStorage();
            } finally {
                setLoading(false);
            }
        }

        // ... (Existing Calculate/Render functions unchanged) ...
        function calculateKPIs(services) {
            const price = parseFloat(els.priceInput.value) || 0;
            const divisor = (typeof JOURNEYS_PER_YEAR !== 'undefined') ? JOURNEYS_PER_YEAR : 464;
            const perJourney = price / divisor;
            
            let counts = { cancel: 0, sev: 0, maj: 0, med: 0, min: 0 };
            let refund = 0;
            services.forEach(s => {
                if (s.isCancelled) { counts.cancel++; refund += perJourney * 0.5; } 
                else if (s.delay >= 120) { counts.sev++; refund += perJourney * 2; } 
                else if (s.delay >= 60) { counts.maj++; refund += perJourney * 1; } 
                else if (s.delay >= 30) { counts.med++; refund += perJourney * 0.5; } 
                else if (s.delay >= 15) { counts.min++; refund += perJourney * 0.25; }
            });

            els.kpiRefund.innerText = `£${refund.toFixed(2)}`;
            els.kpiCancel.innerText = counts.cancel;
            els.kpiSevere.innerText = counts.sev;
            els.kpiMajor.innerText = counts.maj;
            els.kpiMed.innerText = counts.med;
            els.kpiMinor.innerText = counts.min;
        }

        function renderTable(services) {
            els.tableBody.innerHTML = '';
            const showDelaysOnly = els.toggleDelay.checked;
            const displayServices = showDelaysOnly ? services.filter(s => s.delay >= 15 || s.isCancelled) : services;

            if (displayServices.length === 0) { els.noResults.classList.remove('hidden'); return; }
            els.noResults.classList.add('hidden');

            const price = parseFloat(els.priceInput.value) || 0;
            const divisor = (typeof JOURNEYS_PER_YEAR !== 'undefined') ? JOURNEYS_PER_YEAR : 464;
            const perJourney = price / divisor;

            displayServices.forEach(s => {
                const row = document.createElement('tr');
                let statusClass = "text-gray-900";
                let statusText = s.delay > 0 ? `${s.delay}m` : "On Time";
                let refundText = "£0.00";

                if (s.isCancelled) {
                    statusClass = "text-danger"; statusText = "Cancelled"; refundText = `£${(perJourney * 0.5).toFixed(2)}`;
                } else if (s.delay >= 15) {
                    statusClass = s.delay >= 30 ? "text-danger" : "text-orange-500";
                    let mult = s.delay >= 120 ? 2 : s.delay >= 60 ? 1 : s.delay >= 30 ? 0.5 : 0.25;
                    refundText = `£${(perJourney * mult).toFixed(2)}`;
                } else { statusClass = "text-emerald-600"; }

                const formattedSchDep = formatTime(s.schDep);
                const formattedActArr = s.isCancelled ? 'Cancelled' : formatTime(s.actArr);

                row.innerHTML = `
                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-900" data-label="Date">${formatDateForDisplay(new Date(s.date))}</td>
                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-500" data-label="Type">${s.type}</td>
                    <td class="py-3 px-4 whitespace-nowrap text-sm text-gray-500" data-label="Sch. Dep">${formattedSchDep}</td>
                    <td class="py-3 px-4 whitespace-nowrap text-sm font-medium ${s.isCancelled ? 'text-danger' : 'text-gray-900'}" data-label="Act. Arr">${formattedActArr}</td>
                    <td class="py-3 px-4 whitespace-nowrap text-sm font-bold ${statusClass}" data-label="Delay">${statusText}</td>
                    <td class="py-3 px-4 whitespace-nowrap text-sm font-bold text-emerald-600" data-label="Refund">${refundText}</td>
                `;
                els.tableBody.appendChild(row);
            });
        }
        
        // ... (Utilities getMonday, parseApiTime, setupAutocomplete, formatDateForAPI, formatDateForDisplay, formatTime, updateWeekLabel - KEEP SAME) ...
        function getMonday(d) { d = new Date(d); let day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1); return new Date(d.setDate(diff)); }
        function parseApiTime(timeStr) { if (!timeStr || timeStr.length !== 4) return null; const h = parseInt(timeStr.substring(0, 2), 10), m = parseInt(timeStr.substring(2, 4), 10); return new Date(1970, 0, 1, h, m, 0); }
        function setupAutocomplete(input, results, codeInput, isOutbound) { /* ... same ... */ 
            input.addEventListener('input', function() {
                const val = this.value.toLowerCase();
                results.innerHTML = '';
                if (val.length < 2) { results.classList.add('hidden'); return; }
                const matches = stationData.filter(s => s.name.toLowerCase().includes(val) || s.code.toLowerCase().includes(val)).slice(0,5);
                if (matches.length > 0) {
                    results.classList.remove('hidden');
                    matches.forEach(s => {
                        const div = document.createElement('div'); div.className = "px-4 py-2 hover:bg-emerald-50 cursor-pointer text-sm text-gray-700"; div.innerHTML = `<strong>${s.name}</strong> <span class="text-gray-400 text-xs">[${s.code}]</span>`;
                        div.addEventListener('click', () => { input.value = s.name; codeInput.value = s.code; results.classList.add('hidden'); syncReturnJourney(); });
                        results.appendChild(div);
                    });
                } else { results.classList.add('hidden'); }
            });
            document.addEventListener('click', (e) => { if (!input.contains(e.target) && !results.contains(e.target)) results.classList.add('hidden'); });
        }
        function setLoading(bool, msg) { /* ... same ... */ 
             els.btn.disabled = bool;
            if (bool) { els.btnText.textContent = msg || "Analysing..."; els.btnSpinner.classList.remove('hidden'); els.btn.classList.add('opacity-75', 'cursor-wait'); } 
            else { els.btnText.textContent = "Check Performance"; els.btnSpinner.classList.add('hidden'); els.btn.classList.remove('opacity-75', 'cursor-wait'); }
        }
        function showStatus(msg, type) { /* ... same ... */ 
             els.status.textContent = msg;
             els.status.className = `text-center text-xs font-bold mt-2 transition-all ${type === 'error' ? 'text-red-500' : 'text-emerald-600'}`;
             // Removed timeout clear for persistent status in this version
        }
        function formatDateForAPI(d) { return d.toISOString().split('T')[0]; }
        function formatDateForDisplay(d) { return d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' }); }
        function formatTime(t) { if (!t || t.length !== 4) return '--:--'; return `${t.substr(0,2)}:${t.substr(2,2)}`; }
        function updateWeekLabel() { const d = new Date(els.datePicker.value); if (isNaN(d)) return; const day = d.getDay(); const diff = d.getDate() - day + (day == 0 ? -6 : 1); const monday = new Date(d.setDate(diff)); els.wcLabel.textContent = `Week Commencing: ${formatDateForDisplay(monday)}`; }

        init();
    </script>
</body>
</html>