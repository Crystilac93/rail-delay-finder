<!DOCTYPE html>
<html lang="en-GB">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#10b981">
    <title>RefundMyRail | Dashboard</title>

    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="train_icon.png">
    <link rel="apple-touch-icon" href="train_icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="mobile.css">

    <style>
        /* --- Core Defaults --- */
        html {
            scroll-behavior: smooth;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            overscroll-behavior-y: none;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .autocomplete-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: #334155;
            border-bottom: 1px solid #e2e8f0;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background-color: #ecfdf5;
            color: #059669;
        }

        .autocomplete-item strong {
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .mobile-table-card thead {
                display: none;
            }

            .mobile-table-card tbody tr {
                display: flex;
                flex-direction: column;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 0.75rem;
                margin-bottom: 1rem;
                padding: 1rem;
                box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            }

            .mobile-table-card td {
                display: flex;
                justify-content: space-between;
                padding: 0.25rem 0;
                border: none;
                font-size: 0.95rem;
            }

            .mobile-table-card td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #6b7280;
                margin-right: 1rem;
            }

            .mobile-table-card td:last-child {
                margin-top: 0.75rem;
                padding-top: 0.75rem;
                border-top: 1px solid #f3f4f6;
                font-weight: 700;
                font-size: 1.1rem;
            }
        }

        .progress-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 0.5rem;
            overflow: hidden;
            margin-top: 0.75rem;
        }

        .progress-bar {
            height: 100%;
            background-color: #10b981;
            width: 0%;
            transition: width 0.3s ease-out;
        }

        .text-danger {
            color: #ef4444;
            font-weight: 600;
        }

        .text-success {
            color: #22c55e;
            font-weight: 600;
        }

        input[type="time"],
        input[type="date"],
        input[type="text"],
        select {
            -webkit-appearance: none;
            appearance: none;
            background-color: #fff;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.6rem 0.875rem;
            font-size: 1rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }

        #settings-panel {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toggle-checkbox:checked {
            right: 0;
            border-color: #10b981;
        }

        .toggle-checkbox:checked+.toggle-label {
            background-color: #10b981;
        }

        .kpi-card {
            transition: transform 0.2s;
        }

        .kpi-card:active {
            transform: scale(0.98);
        }

        .kpi-scroller {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }

        @media (max-width: 640px) {
            .kpi-scroller {
                display: flex;
                overflow-x: auto;
                padding-bottom: 1rem;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                margin-right: -1rem;
                padding-right: 1rem;
            }

            .kpi-scroller>* {
                flex: 0 0 140px;
                scroll-snap-align: start;
            }
        }

        .autocomplete-results {
            max-height: 200px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .cache-badge {
            display: inline-flex;
            align-items: center;
            background-color: #dbeafe;
            color: #1e40af;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #bfdbfe;
        }

        .api-badge {
            display: inline-flex;
            align-items: center;
            background-color: #dcfce7;
            color: #166534;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #bbf7d0;
        }

        /* TOC Badges */
        .toc-badge {
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: white;
            display: inline-block;
            min-width: 2.5rem;
            text-align: center;
        }

        .toc-gw {
            background-color: #0a4c3f;
        }

        .toc-sw {
            background-color: #0193d7;
        }

        .toc-vt {
            background-color: #b50e24;
        }

        .toc-default {
            background-color: #64748b;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col bg-slate-50">

    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md shadow-sm border-b border-slate-200 fixed w-full z-40">
        <div class="max-w-7xl mx-auto px-6 lg:px-8 h-20 flex items-center justify-between">
            <a href="/" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                <img src="train_icon.png" alt="Logo" class="h-9 w-9">
                <span class="font-extrabold text-xl sm:text-2xl tracking-tight text-slate-900">RefundMyRail</span>
            </a>

            <!-- Nav Links & User Menu -->
            <div class="flex items-center gap-6">
                <div id="nav-links" class="flex items-center gap-4 sm:gap-8">
                    <a href="/app"
                        class="text-sm font-bold text-slate-600 hover:text-emerald-600 transition-colors">Dashboard</a>
                    <a href="/manage"
                        class="hidden sm:block text-sm font-bold text-slate-600 hover:text-emerald-600 transition-colors">Settings</a>
                </div>
                <button id="settings-toggle-button" class="p-2 rounded-lg hover:bg-slate-100 transition-colors"
                    title="Settings">
                    <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </button>
                <div id="user-menu">
                    <!-- Populated by auth-ui.js -->
                    <a href="/login"
                        class="px-4 py-2 text-sm font-bold bg-emerald-600 text-white rounded-lg hover:bg-emerald-500 transition-colors">
                        Login
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Settings Panel -->
    <div id="settings-overlay"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm z-40 hidden opacity-0 transition-opacity duration-300"></div>
    <div id="settings-panel"
        class="fixed inset-y-0 right-0 w-full sm:w-96 bg-white shadow-2xl z-50 transform translate-x-full flex flex-col custom-scrollbar">

        <div class="flex-none px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
            <h2 class="text-lg font-bold text-slate-800">Settings</h2>
            <button id="close-settings-button"
                class="p-2 bg-white rounded-full shadow-sm text-slate-400 hover:text-red-500 border border-slate-200 transition-colors">
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <div class="flex-grow p-6 overflow-y-auto space-y-8">
            <!-- Ticket Settings -->
            <div class="bg-white border border-slate-200 rounded-2xl p-5 shadow-sm">
                <div class="flex items-center mb-4">
                    <div class="p-2 bg-emerald-100 rounded-lg mr-3 text-emerald-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </div>
                    <h3 class="font-bold text-slate-900">Ticket Price</h3>
                </div>
                <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Annual Season
                    Ticket Cost</label>
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">£</span>
                    <input type="text" id="ticket-price-settings" inputmode="decimal" value="7437.92"
                        class="w-full pl-8 pr-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all text-lg font-bold text-slate-900 placeholder-slate-300">
                </div>
            </div>
        </div>

        <div class="flex-none p-6 border-t border-slate-100 bg-slate-50 safe-area-bottom">
            <button type="button" id="save-settings-button"
                class="w-full bg-emerald-600 text-white py-4 px-4 rounded-xl shadow-lg hover:bg-emerald-500 active:scale-[0.98] transition-all text-base font-bold">Save
                Changes</button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow max-w-5xl mx-auto w-full px-4 sm:px-6 pt-24 pb-8 space-y-8">

        <!-- Search Card -->
        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 sm:p-8 bg-white border-b border-slate-100">
                <h1 class="text-2xl font-extrabold text-slate-900 tracking-tight">Find Delays</h1>
                <p class="text-slate-500 text-sm mt-1 font-medium">Analyse your commute for compensation.</p>
            </div>

            <form id="search-form" class="p-6 sm:p-8 space-y-8">

                <!-- Station Selection -->
                <div class="space-y-5">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <div class="autocomplete-container relative">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Home
                                Station</label>
                            <input type="text" id="setting-outbound-from"
                                class="w-full rounded-xl border-slate-200 py-3 text-sm font-semibold text-slate-700 focus:ring-emerald-500 focus:border-emerald-500"
                                placeholder="Station..." value="">
                            <div class="autocomplete-results hidden absolute w-full bg-white border border-slate-200 rounded-b-xl shadow-xl z-50"
                                id="results-setting-outbound-from"></div>
                            <input type="hidden" id="setting-outbound-from-code" value="">
                        </div>
                        <div class="autocomplete-container relative">
                            <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Work
                                Station</label>
                            <input type="text" id="setting-outbound-to"
                                class="w-full rounded-xl border-slate-200 py-3 text-sm font-semibold text-slate-700 focus:ring-emerald-500 focus:border-emerald-500"
                                placeholder="Station..." value="">
                            <div class="autocomplete-results hidden absolute w-full bg-white border border-slate-200 rounded-b-xl shadow-xl z-50"
                                id="results-setting-outbound-to"></div>
                            <input type="hidden" id="setting-outbound-to-code" value="">
                        </div>
                    </div>

                    <!-- Hidden fields for return journey -->
                    <input type="hidden" id="setting-inbound-from" value="">
                    <input type="hidden" id="setting-inbound-from-code" value="">
                    <input type="hidden" id="setting-inbound-to" value="">
                    <input type="hidden" id="setting-inbound-to-code" value="">
                </div>

                <div class="border-t border-slate-100 my-2"></div>

                <!-- Search Type & Date -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Mode</label>
                        <div class="flex bg-slate-100 p-1.5 rounded-xl">
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="search-type" value="week" class="sr-only peer">
                                <span
                                    class="block py-2.5 text-sm font-bold text-slate-500 rounded-lg peer-checked:bg-white peer-checked:text-emerald-600 peer-checked:shadow-sm transition-all">Week
                                    View</span>
                            </label>
                            <label class="flex-1 text-center cursor-pointer">
                                <input type="radio" name="search-type" value="day" class="sr-only peer" checked>
                                <span
                                    class="block py-2.5 text-sm font-bold text-slate-500 rounded-lg peer-checked:bg-white peer-checked:text-emerald-600 peer-checked:shadow-sm transition-all">Single
                                    Day</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3"
                            id="date-picker-label">Select Day</label>
                        <div class="relative">
                            <input type="date" id="date-picker"
                                class="block w-full px-4 py-3 rounded-xl border-slate-200 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 text-slate-800 font-semibold bg-slate-50 hover:bg-white transition-colors">
                        </div>
                        <p id="week-commencing-label" class="text-xs text-emerald-600 mt-2 font-semibold pl-1"
                            style="visibility: hidden;">w/c ...</p>
                    </div>
                </div>

                <!-- Days in Office (Hidden for single day mode default) -->
                <div id="days-in-office-group" style="display: none;">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Days
                        Travelled</label>
                    <div class="flex justify-between gap-2 sm:gap-4">
                        <label class="flex flex-col items-center cursor-pointer group select-none"><input
                                type="checkbox" name="daysInOffice" value="1" checked class="peer sr-only">
                            <div
                                class="w-12 h-12 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center text-sm font-bold peer-checked:bg-emerald-500 peer-checked:text-white transition-all group-active:scale-90 border border-transparent peer-checked:border-emerald-600 shadow-sm">
                                M</div>
                        </label>
                        <label class="flex flex-col items-center cursor-pointer group select-none"><input
                                type="checkbox" name="daysInOffice" value="2" checked class="peer sr-only">
                            <div
                                class="w-12 h-12 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center text-sm font-bold peer-checked:bg-emerald-500 peer-checked:text-white transition-all group-active:scale-90 border border-transparent peer-checked:border-emerald-600 shadow-sm">
                                T</div>
                        </label>
                        <label class="flex flex-col items-center cursor-pointer group select-none"><input
                                type="checkbox" name="daysInOffice" value="3" checked class="peer sr-only">
                            <div
                                class="w-12 h-12 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center text-sm font-bold peer-checked:bg-emerald-500 peer-checked:text-white transition-all group-active:scale-90 border border-transparent peer-checked:border-emerald-600 shadow-sm">
                                W</div>
                        </label>
                        <label class="flex flex-col items-center cursor-pointer group select-none"><input
                                type="checkbox" name="daysInOffice" value="4" checked class="peer sr-only">
                            <div
                                class="w-12 h-12 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center text-sm font-bold peer-checked:bg-emerald-500 peer-checked:text-white transition-all group-active:scale-90 border border-transparent peer-checked:border-emerald-600 shadow-sm">
                                T</div>
                        </label>
                        <label class="flex flex-col items-center cursor-pointer group select-none"><input
                                type="checkbox" name="daysInOffice" value="5" class="peer sr-only">
                            <div
                                class="w-12 h-12 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center text-sm font-bold peer-checked:bg-emerald-500 peer-checked:text-white transition-all group-active:scale-90 border border-transparent peer-checked:border-emerald-600 shadow-sm">
                                F</div>
                        </label>
                    </div>
                </div>

                <!-- Time Selection -->
                <div class="space-y-6 pt-4 border-t border-slate-100">
                    <div class="grid grid-cols-2 gap-6">
                        <div class="col-span-2 flex justify-between items-center"><span
                                class="text-sm font-bold text-slate-900">Morning Commute</span></div>
                        <div><label
                                class="block text-[10px] text-slate-400 uppercase tracking-wider mb-2 font-bold">Depart
                                After</label><input type="time" id="from-time-outbound" value="07:00"
                                class="w-full rounded-xl border-slate-200 text-sm py-3 font-semibold text-slate-700 focus:border-emerald-500 focus:ring-emerald-500">
                        </div>
                        <div><label
                                class="block text-[10px] text-slate-400 uppercase tracking-wider mb-2 font-bold">Depart
                                Before</label><input type="time" id="to-time-outbound" value="07:30"
                                class="w-full rounded-xl border-slate-200 text-sm py-3 font-semibold text-slate-700 focus:border-emerald-500 focus:ring-emerald-500">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-6">
                        <div class="col-span-2 flex justify-between items-center mt-2"><span
                                class="text-sm font-bold text-slate-900">Evening Commute</span></div>
                        <div><label
                                class="block text-[10px] text-slate-400 uppercase tracking-wider mb-2 font-bold">Depart
                                After</label><input type="time" id="from-time-inbound" value="17:00"
                                class="w-full rounded-xl border-slate-200 text-sm py-3 font-semibold text-slate-700 focus:border-emerald-500 focus:ring-emerald-500">
                        </div>
                        <div><label
                                class="block text-[10px] text-slate-400 uppercase tracking-wider mb-2 font-bold">Depart
                                Before</label><input type="time" id="to-time-inbound" value="17:30"
                                class="w-full rounded-xl border-slate-200 text-sm py-3 font-semibold text-slate-700 focus:border-emerald-500 focus:ring-emerald-500">
                        </div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div id="progress-container" class="hidden mb-4 bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <div class="flex justify-between text-xs font-bold text-slate-500 mb-2">
                        <span id="progress-label">Initializing...</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="progress-container bg-slate-200 h-2">
                        <div id="progress-bar"
                            class="progress-bar bg-emerald-500 h-2 rounded-full shadow-[0_0_10px_rgba(16,185,129,0.5)]">
                        </div>
                    </div>
                </div>

                <!-- Action Button -->
                <button type="submit" id="submit-button"
                    class="w-full bg-emerald-600 text-white py-4 rounded-2xl shadow-lg shadow-emerald-200 hover:shadow-emerald-300 hover:bg-emerald-500 focus:outline-none focus:ring-4 focus:ring-emerald-500/30 transition-all duration-200 flex justify-center items-center text-lg font-bold active:scale-[0.98] transform">
                    <span id="btn-text">Check Performance</span>
                    <svg id="btn-spinner" class="animate-spin ml-3 h-5 w-5 text-white hidden"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                </button>

                <!-- Status Message and Cache Indicator -->
                <div id="status-loading-container" class="flex justify-center items-center mt-6 min-h-[1.5rem] gap-2">
                    <div id="status-message" class="text-sm text-center font-medium text-slate-500"></div>
                    <span id="cache-indicator" class="cache-badge hidden" title="Data loaded from internal cache">
                        <svg class="w-3 h-3 mr-1.5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"></path>
                            <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"></path>
                        </svg>
                        Cached Data
                    </span>
                    <span id="api-indicator" class="api-badge hidden" title="Data fetched live from National Rail">
                        <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Live Data
                    </span>
                </div>
            </form>
        </div>

        <!-- Results Section -->
        <div id="results-area" class="hidden space-y-8 transition-opacity duration-500 ease-in-out pb-12">
            <!-- Summary KPI Card -->
            <div>
                <h2 id="in-office-summary-heading" class="text-lg font-extrabold text-slate-900 mb-4 px-2">Results
                    Summary</h2>

                <!-- Refund Total Hero -->
                <div
                    class="refund-hero bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-3xl p-8 text-white shadow-xl shadow-emerald-100 mb-6 flex justify-between items-center transform hover:scale-[1.01] transition-transform duration-300">
                    <div>
                        <p class="text-emerald-100 text-sm font-bold uppercase tracking-wider mb-1">Potential Refund</p>
                        <p id="total-refund-kpi-office" class="text-5xl font-extrabold tracking-tight">£0.00</p>
                    </div>

                </div>

                <!-- Scrollable Stats -->
                <div class="kpi-scroller px-1">
                    <!-- Cancelled -->
                    <div
                        class="kpi-card bg-red-500 rounded-2xl p-5 shadow-sm hover:shadow-md transition-all text-white">
                        <div class="flex items-start justify-between mb-3">
                            <span class="bg-white/20 p-2 rounded-xl"><svg class="w-5 h-5" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12" />
                                </svg></span>
                            <span class="text-3xl font-extrabold" id="cancelled-kpi-office">0</span>
                        </div>
                        <p class="text-xs font-bold text-white/80 uppercase tracking-wider">Cancelled</p>
                    </div>
                    <!-- Severe -->
                    <div
                        class="kpi-card bg-red-600 rounded-2xl p-5 shadow-sm hover:shadow-md transition-all text-white">
                        <div class="flex items-start justify-between mb-3">
                            <span class="bg-white/20 p-2 rounded-xl"><svg class="w-5 h-5" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg></span>
                            <span class="text-3xl font-extrabold" id="delayed-120-plus-office">0</span>
                        </div>
                        <p class="text-xs font-bold text-white/80 uppercase tracking-wider">Severe (120+)</p>
                    </div>
                    <!-- Major -->
                    <div
                        class="kpi-card bg-orange-500 rounded-2xl p-5 shadow-sm hover:shadow-md transition-all text-white">
                        <div class="flex items-start justify-between mb-3">
                            <span class="bg-white/20 p-2 rounded-xl"><svg class="w-5 h-5" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg></span>
                            <span class="text-3xl font-extrabold" id="delayed-60-119-office">0</span>
                        </div>
                        <p class="text-xs font-bold text-white/80 uppercase tracking-wider">Long (60+)</p>
                    </div>
                    <!-- Medium -->
                    <div
                        class="kpi-card bg-amber-500 rounded-2xl p-5 shadow-sm hover:shadow-md transition-all text-white">
                        <div class="flex items-start justify-between mb-3">
                            <span class="bg-white/20 p-2 rounded-xl"><svg class="w-5 h-5" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg></span>
                            <span class="text-3xl font-extrabold" id="delayed-30-59-office">0</span>
                        </div>
                        <p class="text-xs font-bold text-white/80 uppercase tracking-wider">Medium (30+)</p>
                    </div>
                    <!-- Minor -->
                    <div
                        class="kpi-card bg-yellow-500 rounded-2xl p-5 shadow-sm hover:shadow-md transition-all text-white">
                        <div class="flex items-start justify-between mb-3">
                            <span class="bg-white/20 p-2 rounded-xl"><svg class="w-5 h-5" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg></span>
                            <span class="text-3xl font-extrabold" id="delayed-15-29-office">0</span>
                        </div>
                        <p class="text-xs font-bold text-white/80 uppercase tracking-wider">Short (15+)</p>
                    </div>
                </div>
            </div>

            <!-- Detail List -->
            <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="bg-white px-6 py-5 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800 text-lg">Journey Details</h3>
                    <div class="flex items-center">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider mr-3">Delays Only</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggle-office-delays" class="sr-only peer" checked>
                            <div
                                class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-emerald-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500">
                            </div>
                        </label>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full mobile-table-card" id="results-table-office">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th
                                    class="py-4 px-6 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    Date</th>
                                <th
                                    class="py-4 px-6 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    Type</th>
                                <th
                                    class="py-4 px-6 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    Rail Operator</th>
                                <th
                                    class="py-4 px-6 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    Sch. Dep</th>
                                <th
                                    class="py-4 px-6 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    Act. Arr</th>
                                <th
                                    class="py-4 px-6 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    Delay</th>
                                <th
                                    class="py-4 px-6 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    Refund</th>
                                <th
                                    class="py-4 px-6 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">
                                    Claim</th>
                            </tr>
                        </thead>
                        <tbody id="results-body-office" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
                <p id="no-office-results" class="hidden text-center text-slate-500 py-12 text-sm font-medium">No
                    matching journeys found.</p>
            </div>
        </div>

    </main>

    <footer class="mt-12 py-8 text-center text-xs font-medium text-slate-400 border-t border-slate-200 bg-slate-50">
        <div class="max-w-7xl mx-auto px-4">
            <p class="mb-2">Contains National Rail data © 2025. Source: Rail Delivery Group.</p>
            <p>RefundMyRail is an independent tool and is not affiliated with National Rail.</p>
        </div>
    </footer>

    <!-- Load Config first -->
    <script src="config.js"></script>
    <!-- Load Station Data second -->
    <script src="station_data.js"></script>

    <script>
        // ... (Dom Elements) ...
        const els = {
            form: document.getElementById('search-form'),
            btn: document.getElementById('submit-button'),
            btnText: document.getElementById('btn-text'),
            btnSpinner: document.getElementById('btn-spinner'),
            status: document.getElementById('status-message'),
            progressContainer: document.getElementById('progress-container'),
            progressBar: document.getElementById('progress-bar'),
            progressLabel: document.getElementById('progress-label'),
            progressPercent: document.getElementById('progress-percent'),
            cacheIndicator: document.getElementById('cache-indicator'),
            apiIndicator: document.getElementById('api-indicator'),
            resultsArea: document.getElementById('results-area'),
            settingsPanel: document.getElementById('settings-panel'),
            settingsOverlay: document.getElementById('settings-overlay'),
            settingsToggle: document.getElementById('settings-toggle-button'),
            settingsClose: document.getElementById('close-settings-button'),
            settingsSave: document.getElementById('save-settings-button'),
            datePicker: document.getElementById('date-picker'),
            wcLabel: document.getElementById('week-commencing-label'),
            searchTypeRadios: document.querySelectorAll('input[name="search-type"]'),
            officeDaysContainer: document.getElementById('days-in-office-group'),
            officeDaysInputs: document.querySelectorAll('input[name="daysInOffice"]'),
            priceInput: document.getElementById('ticket-price-settings'),
            outFrom: document.getElementById('setting-outbound-from'),
            outTo: document.getElementById('setting-outbound-to'),
            inFrom: document.getElementById('setting-inbound-from'),
            inTo: document.getElementById('setting-inbound-to'),
            outFromCode: document.getElementById('setting-outbound-from-code'),
            outToCode: document.getElementById('setting-outbound-to-code'),
            inFromCode: document.getElementById('setting-inbound-from-code'),
            inToCode: document.getElementById('setting-inbound-to-code'),
            timeOutStart: document.getElementById('from-time-outbound'),
            timeOutEnd: document.getElementById('to-time-outbound'),
            timeInStart: document.getElementById('from-time-inbound'),
            timeInEnd: document.getElementById('to-time-inbound'),
            outRouteDisplay: document.getElementById('outbound-route-display'),
            inRouteDisplay: document.getElementById('inbound-route-display'),
            tableBody: document.getElementById('results-body-office'),
            noResults: document.getElementById('no-office-results'),
            toggleDelay: document.getElementById('toggle-office-delays'),
            kpiRefund: document.getElementById('total-refund-kpi-office'),
            kpiCancel: document.getElementById('cancelled-kpi-office'),
            kpiSevere: document.getElementById('delayed-120-plus-office'),
            kpiMajor: document.getElementById('delayed-60-119-office'),
            kpiMed: document.getElementById('delayed-30-59-office'),
            kpiMinor: document.getElementById('delayed-15-29-office')
        };

        const JOB_STORAGE_KEY = 'railDelayActiveJob';

        // --- Job Management ---
        function saveJobToStorage(jobData) {
            localStorage.setItem(JOB_STORAGE_KEY, JSON.stringify({ timestamp: Date.now(), data: jobData }));
        }

        function getJobFromStorage() {
            const stored = localStorage.getItem(JOB_STORAGE_KEY);
            if (!stored) return null;
            const data = JSON.parse(stored);
            if (Date.now() - data.timestamp > 60 * 60 * 1000) { localStorage.removeItem(JOB_STORAGE_KEY); return null; }
            return data.data;
        }

        function clearJobStorage() { localStorage.removeItem(JOB_STORAGE_KEY); }

        function updateProgress(completed, total, statusText) {
            const pct = Math.round((completed / total) * 100);
            els.progressContainer.classList.remove('hidden');
            els.progressBar.style.width = `${pct}%`;
            els.progressPercent.innerText = `${pct}%`;
            els.progressLabel.innerText = statusText;
        }

        // --- Initialization ---
        function init() {
            const today = new Date();
            els.datePicker.value = formatDateForAPI(today);
            updateWeekLabel();
            loadSettings();

            els.settingsToggle.addEventListener('click', () => toggleSettings(true));
            els.settingsClose.addEventListener('click', () => toggleSettings(false));
            els.settingsOverlay.addEventListener('click', () => toggleSettings(false));
            els.settingsSave.addEventListener('click', saveSettings);
            els.form.addEventListener('submit', handleSearch);
            els.datePicker.addEventListener('change', updateWeekLabel);
            els.searchTypeRadios.forEach(r => {
                r.addEventListener('change', (e) => {
                    const isWeek = e.target.value === 'week';
                    els.officeDaysContainer.style.display = isWeek ? 'block' : 'none';
                    document.getElementById('date-picker-label').innerText = isWeek ? 'Select Week' : 'Select Day';
                    updateWeekLabel();
                    if (isWeek) {
                        els.wcLabel.style.visibility = 'visible';
                    } else {
                        els.wcLabel.style.visibility = 'hidden';
                    }
                });
            });
            els.priceInput.addEventListener('blur', () => {
                const val = parseFloat(els.priceInput.value.replace(/[^0-9.]/g, '')) || 0;
                els.priceInput.value = val.toFixed(2);
            });

            if (typeof stationData !== 'undefined') {
                setupAutocomplete(els.outFrom, document.getElementById('results-setting-outbound-from'), els.outFromCode);
                setupAutocomplete(els.outTo, document.getElementById('results-setting-outbound-to'), els.outToCode);
                setupAutocomplete(els.inFrom, document.getElementById('results-setting-inbound-from'), els.inFromCode);
                setupAutocomplete(els.inTo, document.getElementById('results-setting-inbound-to'), els.inToCode);
            }

            els.toggleDelay.addEventListener('change', () => renderTable(lastResults));

            const savedData = getJobFromStorage();
            if (savedData) {
                if (savedData.metricsJobIds) { resumeMonitoring(savedData); }
            }
        }

        // --- UPDATED: Smart Resume Monitoring ---
        async function resumeMonitoring(savedData) {
            // If we have saved metrics job IDs, try to recover the session immediately
            if (!savedData || !savedData.metricsJobIds || savedData.metricsJobIds.length === 0) {
                clearJobStorage();
                return;
            }

            setLoading(true, "Restoring previous session...");
            els.resultsArea.classList.add('hidden');
            els.progressContainer.classList.remove('hidden');
            updateProgress(5, 100, "Checking previous search...");

            try {
                // 1. Re-poll the metric jobs. Since they are likely cached or done, this should be fast.
                // Note: savedData.metricsJobIds is now expected to be an array of { jobId, req } objects.
                // We need the 'req' object to reconstruct the service list correctly (Date, Type, From, To).
                const metricJobObjects = savedData.metricsJobIds;

                const metricResults = await Promise.all(metricJobObjects.map(async (item) => {
                    // If the stored item is just a string ID (legacy), we can't fully recover metadata, so fail gracefully
                    if (typeof item === 'string') throw new Error("Legacy storage format");

                    const data = await pollJob(item.jobId);
                    return { data, req: item.req };
                }));

                // 2. Reconstruct the 'allServices' list from the polled results
                let allServices = [];
                let allRids = [];
                let hasCachedData = false;

                metricResults.forEach(result => {
                    const data = result.data;
                    const req = result.req; // Restored request metadata

                    if (data._fromCache) hasCachedData = true;

                    if (data.Services) {
                        data.Services.forEach(s => {
                            const rid = s.serviceAttributesMetrics?.rids?.[0];
                            if (rid && !allRids.includes(rid)) {
                                allRids.push(rid);
                                allServices.push({
                                    rid,
                                    date: req.d,
                                    type: req.j.type,
                                    from: req.j.from,
                                    to: req.j.to
                                });
                            }
                        });
                    }
                });

                if (hasCachedData) els.cacheIndicator.classList.remove('hidden'); else els.apiIndicator.classList.remove('hidden');

                // 3. Resume Phase 2: Detail Fetching
                if (allServices.length === 0) {
                    showStatus("No services found in previous session.", "info");
                    setLoading(false);
                    els.progressContainer.classList.add('hidden');
                    clearJobStorage();
                    return;
                }

                await analyzeServices(allServices);

            } catch (e) {
                console.warn("Resume failed:", e);
                clearJobStorage();
                showStatus("Previous session expired. Please search again.", "warning");
                setLoading(false);
                els.progressContainer.classList.add('hidden');
            }
        }

        // --- UPDATED loadSettings ---
        async function loadSettings() {
            // Try to load from server first if user is authenticated
            try {
                const res = await fetch('/api/user/preferences', { credentials: 'include' });
                if (res.ok) {
                    const s = await res.json();
                    console.log('✅ Loaded preferences from server:', s);

                    if (s.ticketPrice) els.priceInput.value = s.ticketPrice;
                    if (s.fromTimeOutbound) els.timeOutStart.value = s.fromTimeOutbound;
                    if (s.toTimeOutbound) els.timeOutEnd.value = s.toTimeOutbound;
                    if (s.fromTimeInbound) els.timeInStart.value = s.fromTimeInbound;
                    if (s.toTimeInbound) els.timeInEnd.value = s.toTimeInbound;

                    // Load default stations from server preferences
                    if (s.homeStation) els.outFrom.value = s.homeStation;
                    if (s.homeStationCode) els.outFromCode.value = s.homeStationCode;
                    if (s.workStation) els.outTo.value = s.workStation;
                    if (s.workStationCode) els.outToCode.value = s.workStationCode;

                    // Sync the return journey (reverse the stations)
                    syncReturnJourney();
                    return; // Successfully loaded from server
                }
            } catch (e) {
                console.warn('Could not load server preferences, falling back to localStorage:', e);
            }

            // Fallback to localStorage if server fetch failed or user not authenticated
            const stored = localStorage.getItem('railDelaySettings');
            if (stored) {
                try {
                    const s = JSON.parse(stored);
                    if (s.ticketPrice) els.priceInput.value = s.ticketPrice;
                    if (s.fromTimeOutbound) els.timeOutStart.value = s.fromTimeOutbound;
                    if (s.toTimeOutbound) els.timeOutEnd.value = s.toTimeOutbound;
                    if (s.fromTimeInbound) els.timeInStart.value = s.fromTimeInbound;
                    if (s.toTimeInbound) els.timeInEnd.value = s.toTimeInbound;

                    if (s.officeDays) {
                        els.officeDaysInputs.forEach(cb => cb.checked = s.officeDays.includes(cb.value));
                    }
                    // Load default stations from settings
                    if (s.homeStation) els.outFrom.value = s.homeStation;
                    if (s.homeStationCode) els.outFromCode.value = s.homeStationCode;
                    if (s.workStation) els.outTo.value = s.workStation;
                    if (s.workStationCode) els.outToCode.value = s.workStationCode;

                    // Sync the return journey (reverse the stations)
                    syncReturnJourney();
                } catch (e) {
                    console.error("Error loading settings", e);
                }
            }
        }

        function saveSettings() {
            const days = Array.from(els.officeDaysInputs).filter(c => c.checked).map(c => c.value);
            const s = { ticketPrice: els.priceInput.value, fromTimeOutbound: els.timeOutStart.value, toTimeOutbound: els.timeOutEnd.value, fromTimeInbound: els.timeInStart.value, toTimeInbound: els.timeInEnd.value, officeDays: days };
            localStorage.setItem('railDelaySettings', JSON.stringify(s));
            toggleSettings(false); showStatus('Settings saved', 'success');
        }
        function syncReturnJourney() { els.inFrom.value = els.outTo.value; els.inFromCode.value = els.outToCode.value; els.inTo.value = els.outFrom.value; els.inToCode.value = els.outFromCode.value; }
        function updateRouteLabels() {
            if (els.outRouteDisplay) els.outRouteDisplay.textContent = '';
            if (els.inRouteDisplay) els.inRouteDisplay.textContent = '';
        }
        function toggleSettings(show) { if (show) { els.settingsOverlay.classList.remove('hidden'); els.settingsPanel.classList.remove('translate-x-full'); setTimeout(() => els.settingsOverlay.classList.remove('opacity-0'), 10); } else { els.settingsOverlay.classList.add('opacity-0'); els.settingsPanel.classList.add('translate-x-full'); setTimeout(() => els.settingsOverlay.classList.add('hidden'), 300); } }

        let lastResults = [];
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function pollJob(jobId) {
            const MAX_ATTEMPTS = 300;
            let attempts = 0;
            while (attempts < MAX_ATTEMPTS) {
                try {
                    const response = await fetch(`/api/job/${jobId}`);
                    if (response.status === 404) throw new Error('Job expired or not found.');
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const json = await response.json();
                    if (json.status === 'completed') return json.data;
                    if (json.status === 'failed') throw new Error(json.error || 'Job failed');
                    await wait(2000);
                    attempts++;
                } catch (e) { throw e; }
            }
            throw new Error('Timeout');
        }

        // --- NEW: Extracted Analysis Logic for reuse ---
        async function analyzeServices(allServices) {
            updateProgress(40, 100, `Analyzing ${allServices.length} trains...`);

            let detailJobIds = [];
            for (const svc of allServices) {
                const res = await fetch(DETAILS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ rid: svc.rid }) });
                if (res.ok) {
                    const { jobId } = await res.json();
                    detailJobIds.push({ jobId, svc });
                }
            }

            let completedDetails = 0;
            let detailedServices = [];

            await Promise.all(detailJobIds.map(async (item) => {
                try {
                    const detailsData = await pollJob(item.jobId);
                    completedDetails++;
                    const prog = 40 + Math.round((completedDetails / detailJobIds.length) * 50);
                    updateProgress(prog, 100, `Analyzing ${completedDetails}/${detailJobIds.length} trains...`);

                    if (detailsData) {
                        const locs = detailsData.serviceAttributesDetails?.locations || [];
                        const dep = locs.find(l => l.location === item.svc.from);
                        const arr = locs.find(l => l.location === item.svc.to);
                        if (dep && arr) {
                            const isCancelled = !arr.actual_ta || arr.actual_ta === "";
                            let delay = 0;
                            if (!isCancelled) {
                                const schTime = parseApiTime(arr.gbtt_pta);
                                const actTime = parseApiTime(arr.actual_ta);
                                if (schTime && actTime) {
                                    if (actTime < schTime - 43200000) actTime.setDate(actTime.getDate() + 1);
                                    delay = Math.max(0, Math.round((actTime - schTime) / 60000));
                                }
                            }
                            detailedServices.push({
                                date: item.svc.date,
                                type: item.svc.type,
                                schDep: dep.gbtt_ptd,
                                schArr: arr.gbtt_pta,
                                actArr: arr.actual_ta,
                                delay: delay,
                                isCancelled: isCancelled,
                                toc: detailsData.serviceAttributesDetails.toc_code
                            });
                        }
                    }
                } catch (e) { console.warn(e); }
            }));

            updateProgress(100, 100, "Finalizing...");

            detailedServices.sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return a.schDep.localeCompare(b.schDep);
            });

            lastResults = detailedServices;
            calculateKPIs(detailedServices);
            renderTable(detailedServices);

            els.resultsArea.classList.remove('hidden');
            els.progressContainer.classList.add('hidden');
            showStatus("Analysis Complete", "success");
            clearJobStorage();
            setTimeout(() => els.resultsArea.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
            setLoading(false);
        }

        async function handleSearch(e) {
            e.preventDefault();
            if (typeof METRICS_URL === 'undefined') { showStatus('Config Error', 'error'); return; }

            setLoading(true);
            els.resultsArea.classList.add('hidden');
            els.progressContainer.classList.remove('hidden');
            els.cacheIndicator.classList.add('hidden');
            els.apiIndicator.classList.add('hidden');

            updateProgress(0, 100, "Initializing...");

            const searchType = document.querySelector('input[name="search-type"]:checked').value;
            const isWeek = searchType === 'week';
            const dateStr = els.datePicker.value;
            const officeDays = new Set();
            if (isWeek) els.officeDaysInputs.forEach(cb => { if (cb.checked) officeDays.add(parseInt(cb.value, 10)); });

            let daysToFetch = [];
            if (isWeek) {
                const monday = getMonday(new Date(dateStr));
                for (let i = 0; i < 5; i++) {
                    const d = new Date(monday.getTime());
                    d.setDate(monday.getDate() + i);
                    daysToFetch.push(formatDateForAPI(d));
                }
            } else { daysToFetch.push(dateStr); }

            const journeys = [
                { type: "Outbound", from: els.outFromCode.value, to: els.outToCode.value, start: els.timeOutStart.value, end: els.timeOutEnd.value },
                { type: "Inbound", from: els.inFromCode.value, to: els.inToCode.value, start: els.timeInStart.value, end: els.timeInEnd.value }
            ];

            console.log('🔍 Journey codes:', {
                outFromDisplay: els.outFrom.value,
                outFromCode: els.outFromCode.value,
                outToDisplay: els.outTo.value,
                outToCode: els.outToCode.value
            });

            if (!journeys[0].from || !journeys[0].to) {
                showStatus("Please select both Home and Work stations.", "error");
                setLoading(false);
                els.progressContainer.classList.add('hidden');
                return;
            }

            let allServices = [];
            let allRids = [];
            let hasCachedData = false;
            let metricRequests = [];

            for (const d of daysToFetch) {
                const dayDate = new Date(d);
                const dayIndex = dayDate.getDay();
                if (isWeek && !officeDays.has(dayIndex)) continue;
                for (const j of journeys) { metricRequests.push({ d, j }); }
            }

            updateProgress(5, 100, "Queuing search requests...");

            let metricJobIds = [];
            try {
                for (const req of metricRequests) {
                    const payload = {
                        from_loc: req.j.from, to_loc: req.j.to,
                        from_time: req.j.start.replace(':', ''), to_time: req.j.end.replace(':', ''),
                        from_date: req.d, to_date: req.d, days: "WEEKDAY"
                    };
                    console.log('📤 Sending payload:', payload);
                    const res = await fetch(METRICS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!res.ok) throw new Error("Submit failed");
                    const { jobId } = await res.json();
                    metricJobIds.push({ jobId, req });
                }

                // UPDATED: Save full object including 'req' metadata, not just IDs
                saveJobToStorage({ metricsJobIds: metricJobIds });

                let completedMetrics = 0;
                updateProgress(10, 100, "Waiting for service lists...");

                const metricResults = await Promise.all(metricJobIds.map(async (item) => {
                    const data = await pollJob(item.jobId);
                    completedMetrics++;
                    const prog = 10 + Math.round((completedMetrics / metricRequests.length) * 30);
                    updateProgress(prog, 100, `Found services for ${item.req.d}...`);
                    if (data._fromCache) hasCachedData = true;
                    if (data.Services) {
                        data.Services.forEach(s => {
                            const rid = s.serviceAttributesMetrics?.rids?.[0];
                            if (rid && !allRids.includes(rid)) {
                                allRids.push(rid);
                                allServices.push({ rid, date: item.req.d, type: item.req.j.type, from: item.req.j.from, to: item.req.j.to });
                            }
                        });
                    }
                    return data;
                }));

                if (allServices.length === 0) {
                    showStatus("No services found.", "info");
                    setLoading(false);
                    els.progressContainer.classList.add('hidden');
                    clearJobStorage();
                    return;
                }

                if (hasCachedData) els.cacheIndicator.classList.remove('hidden'); else els.apiIndicator.classList.remove('hidden');

                // Hand off to the shared analysis function
                await analyzeServices(allServices);

            } catch (e) {
                showStatus("Error: " + e.message, "error");
                els.progressContainer.classList.add('hidden');
                clearJobStorage();
                setLoading(false);
            }
        }

        function calculateKPIs(services) {
            const price = parseFloat(els.priceInput.value) || 0;
            const divisor = (typeof JOURNEYS_PER_YEAR !== 'undefined') ? JOURNEYS_PER_YEAR : 464;
            const perJourney = price / divisor;

            let counts = { cancel: 0, sev: 0, maj: 0, med: 0, min: 0 };
            let maxRefunds = {};

            services.forEach(s => {
                let refund = 0;
                if (s.isCancelled) {
                    counts.cancel++;
                    refund = perJourney * 0.5;
                } else if (s.delay >= 120) {
                    counts.sev++;
                    refund = perJourney * 2;
                } else if (s.delay >= 60) {
                    counts.maj++;
                    refund = perJourney * 1;
                } else if (s.delay >= 30) {
                    counts.med++;
                    refund = perJourney * 0.5;
                } else if (s.delay >= 15) {
                    counts.min++;
                    refund = perJourney * 0.25;
                }

                const key = `${s.date}_${s.type}`;
                if (!maxRefunds[key] || refund > maxRefunds[key]) {
                    maxRefunds[key] = refund;
                }
            });

            let totalRefund = 0;
            for (const key in maxRefunds) {
                totalRefund += maxRefunds[key];
            }

            els.kpiRefund.innerText = `£${totalRefund.toFixed(2)}`;
            els.kpiCancel.innerText = counts.cancel;
            els.kpiSevere.innerText = counts.sev;
            els.kpiMajor.innerText = counts.maj;
            els.kpiMed.innerText = counts.med;
            els.kpiMinor.innerText = counts.min;
        }

        function renderTable(services) {
            els.tableBody.innerHTML = '';
            const showDelaysOnly = els.toggleDelay.checked;
            const displayServices = showDelaysOnly ? services.filter(s => s.delay >= 15 || s.isCancelled) : services;

            if (displayServices.length === 0) { els.noResults.classList.remove('hidden'); return; }
            els.noResults.classList.add('hidden');
            const price = parseFloat(els.priceInput.value) || 0;
            const divisor = (typeof JOURNEYS_PER_YEAR !== 'undefined') ? JOURNEYS_PER_YEAR : 464;
            const perJourney = price / divisor;

            // NEW: Define Delay Repay links for common TOCs
            const tocLinks = {
                'GW': 'https://www.gwr.com/help-and-support/refunds-and-compensation/delay-repay',
                'SW': 'https://www.southwesternrailway.com/contact-and-help/refunds-and-compensation/delay-repay',
                'VT': 'https://www.avantiwestcoast.co.uk/help-and-support/delay-repay',
                'SE': 'https://www.southeasternrailway.co.uk/help-and-contact/refunds-and-compensation-claims/delay-repay',
                'SN': 'https://www.southernrailway.com/help-and-support/delay-repay',
                'TL': 'https://www.thameslinkrailway.com/help-and-support/delay-repay',
                'GN': 'https://www.greatnorthernrail.com/help-and-support/delay-repay',
                'KX': 'https://www.gatwickexpress.com/help-and-support/delay-repay',
                'LM': 'https://www.londonnorthwesternrailway.co.uk/about-us/delay-repay',
                'EM': 'https://www.eastmidlandsrailway.co.uk/help-manage/delay-repay',
                'NE': 'https://www.lner.co.uk/support/delay-repay/',
                'NT': 'https://www.northernrailway.co.uk/help/delay-repay',
                'TP': 'https://www.tpexpress.co.uk/help/delay-repay-compensation',
                'XC': 'https://www.crosscountrytrains.co.uk/customer-service/delay-repay',
                'CC': 'https://www.c2c-online.co.uk/help-feedback/delay-repay/',
                'CH': 'https://www.chilternrailways.co.uk/delayrepay15',
                'GA': 'https://www.greateranglia.co.uk/about-us/our-performance/delay-repay',
                'AW': 'https://tfw.wales/help-and-contact/rail/delay-repay',
                'SR': 'https://www.scotrail.co.uk/plan-your-journey/refunds-and-compensation/delay-repay',
                'GX': 'https://www.gatwickexpress.com/help-and-support/delay-repay'
            };

            displayServices.forEach(s => {
                const row = document.createElement('tr');
                let statusClass = "text-slate-900 font-medium";
                let statusText = s.delay > 0 ? `${s.delay}m` : "On Time";
                let refundText = "£0.00";

                // NEW: Determine claim eligibility
                let isClaimable = false;
                if (s.isCancelled) {
                    statusClass = "text-red-600 font-bold";
                    statusText = "Cancelled";
                    refundText = `£${(perJourney * 0.5).toFixed(2)}`;
                    isClaimable = true;
                } else if (s.delay >= 15) {
                    statusClass = s.delay >= 30 ? "text-red-600 font-bold" : "text-orange-500 font-bold";
                    let mult = s.delay >= 120 ? 2 : s.delay >= 60 ? 1 : s.delay >= 30 ? 0.5 : 0.25;
                    refundText = `£${(perJourney * mult).toFixed(2)}`;
                    isClaimable = true;
                } else {
                    statusClass = "text-emerald-600";
                }

                const formattedSchDep = formatTime(s.schDep);
                const formattedActArr = s.isCancelled ? 'Cancelled' : formatTime(s.actArr);

                let tocBadge = '';
                if (s.toc) {
                    let tocClass = 'toc-default';
                    if (s.toc === 'GW') tocClass = 'toc-gw';
                    else if (s.toc === 'SW') tocClass = 'toc-sw';
                    else if (s.toc === 'VT') tocClass = 'toc-vt';
                    tocBadge = `<span class="toc-badge ${tocClass} ml-2">${s.toc}</span>`;
                }

                // NEW: Generate Claim Button Logic
                let claimHtml = '<span class="text-slate-300">-</span>';
                if (isClaimable) {
                    let url = tocLinks[s.toc];
                    // If no direct link found, fallback to smart google search
                    if (!url) {
                        url = `https://www.google.com/search?q=${s.toc}+delay+repay`;
                    }
                    claimHtml = `<a href="${url}" target="_blank" class="inline-flex items-center px-3 py-1 bg-emerald-100 text-emerald-700 text-xs font-bold rounded-full hover:bg-emerald-200 transition-colors">
                                    Claim
                                    <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                 </a>`;
                }

                row.innerHTML = `
                    <td class="py-4 px-6 whitespace-nowrap text-sm text-slate-700" data-label="Date">${formatDateForDisplay(new Date(s.date))}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-sm text-slate-500 flex items-center" data-label="Type">${s.type}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-sm text-slate-700 font-medium" data-label="Rail Operator">${tocBadge}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-sm text-slate-700 font-medium" data-label="Sch. Dep">${formattedSchDep}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-sm font-medium ${s.isCancelled ? 'text-red-600' : 'text-slate-700'}" data-label="Act. Arr">${formattedActArr}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-sm ${statusClass}" data-label="Delay">${statusText}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-sm font-bold text-emerald-600" data-label="Refund">${refundText}</td>
                    <td class="py-4 px-6 whitespace-nowrap text-sm" data-label="Claim">${claimHtml}</td>
                `;
                els.tableBody.appendChild(row);
            });
        }

        function getMonday(d) { d = new Date(d); let day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1); return new Date(d.setDate(diff)); }
        function parseApiTime(timeStr) { if (!timeStr || timeStr.length !== 4) return null; const h = parseInt(timeStr.substring(0, 2), 10), m = parseInt(timeStr.substring(2, 4), 10); return new Date(1970, 0, 1, h, m, 0); }
        function syncReturnJourney() { if (els.outFrom.value && els.outTo.value) { els.inFrom.value = els.outTo.value; els.inTo.value = els.outFrom.value; els.inFromCode.value = els.outToCode.value; els.inToCode.value = els.outFromCode.value; } }
        function setupAutocomplete(input, results, codeInput) {
            input.addEventListener('input', function () {
                const val = this.value.toLowerCase();
                results.innerHTML = '';
                if (val.length < 2) { results.classList.add('hidden'); return; }
                const matches = stationData.filter(s => s.name.toLowerCase().includes(val) || s.code.toLowerCase().includes(val)).slice(0, 5);
                if (matches.length > 0) {
                    results.classList.remove('hidden');
                    matches.forEach(s => {
                        const div = document.createElement('div');
                        div.className = "autocomplete-item";
                        div.innerHTML = `<strong>${s.name}</strong> <span class="text-slate-400 text-xs ml-1">[${s.code}]</span>`;
                        div.addEventListener('click', () => {
                            input.value = s.name;
                            codeInput.value = s.code;
                            results.classList.add('hidden');
                            syncReturnJourney();
                        });
                        results.appendChild(div);
                    });
                } else { results.classList.add('hidden'); }
            });
            document.addEventListener('click', (e) => { if (!input.contains(e.target) && !results.contains(e.target)) results.classList.add('hidden'); });
        }
        function setLoading(bool, msg) {
            els.btn.disabled = bool;
            if (bool) { els.btnText.textContent = msg || "Analysing..."; els.btnSpinner.classList.remove('hidden'); els.btn.classList.add('opacity-75', 'cursor-wait'); }
            else { els.btnText.textContent = "Check Performance"; els.btnSpinner.classList.add('hidden'); els.btn.classList.remove('opacity-75', 'cursor-wait'); }
        }
        function showStatus(msg, type) {
            els.status.textContent = msg;
            els.status.className = `text-center text-sm font-medium mt-2 transition-all ${type === 'error' ? 'text-red-500' : 'text-slate-500'}`;
        }
        function formatDateForAPI(d) { return d.toISOString().split('T')[0]; }
        function formatDateForDisplay(d) { return d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' }); }
        function formatTime(t) { if (!t || t.length !== 4) return '--:--'; return `${t.substr(0, 2)}:${t.substr(2, 2)}`; }
        function updateWeekLabel() { const d = new Date(els.datePicker.value); if (isNaN(d)) return; const day = d.getDay(); const diff = d.getDate() - day + (day == 0 ? -6 : 1); const monday = new Date(d.setDate(diff)); els.wcLabel.textContent = `Week Commencing: ${formatDateForDisplay(monday)}`; }

        init();
    </script>
    <!-- Auth UI Utilities -->
    <script src="auth-ui.js"></script>
    <script>
        // Initialize auth UI and protect this route
        (async () => {
            const authState = await initAuthUI();

            // Require authentication for dashboard
            if (!authState.isAuthenticated) {
                const currentPath = window.location.pathname;
                window.location.href = `/login?redirect=${encodeURIComponent(currentPath)}`;
            }
        })();
    </script>
</body>
</body>

</html>